#!/usr/bin/env python3
import pandas as pd
import os
import sys

# === User-specific settings ===
INPUT_FILE        = r"Path_to_your_Excel_file.xlsx"
SHEET_NAME        = "your_sheet_name"
COLUMN1           = "Sequence Name"   # Excel column header for sequence names
COLUMN2           = "Sequence"        # Excel column header for sequences
OUTPUT_DIR        = r"path_to_your_desired_directory"  # base output directory

CONST_HEADER      = ">name_of_prot"     # (ex: "EGF")
CONST_SEQUENCE    = ("amino_acid_seq")      #  (ex: "NSDSECPLSHDGYCLHDGVCMYIEALDKYACNCVVGYIGERCQYRDLKWWELR")   

SM_PROT           = "T"   # e.g. 'E' for EGF, 'T' for TGFa
FILES_PER_FOLDER  = 15    # how many fasta files per subfolder

# === Functions ===

def read_excel(path, sheet_name):
    try:
        df = pd.read_excel(
            path,
            sheet_name=sheet_name,
            usecols="A,B",
            header=0,
            names=[COLUMN1, COLUMN2]
        )
    except Exception as e:
        sys.exit(f"Error reading Excel file '{path}': {e}")
    return df


def write_all_fasta(df, col1, col2, base_outdir, const_header, const_seq,
                    sm_prot, files_per_folder):
    # Verify columns
    missing = [c for c in (col1, col2) if c not in df.columns]
    if missing:
        sys.exit(f"Columns not found: {', '.join(missing)}")

    count = 0
    for _, row in df.iterrows():
        header_val = str(row[col1]).strip()
        seq_val    = str(row[col2]).strip()
        if not header_val or header_val.lower() == 'nan':
            continue

        # Determine batch folder index
        batch_idx = (count // files_per_folder) + 1
        batch_folder = os.path.join(
            base_outdir,
            f"{sm_prot}Batch{batch_idx:02d}"
        )
        os.makedirs(batch_folder, exist_ok=True)

        # Write fasta file
        outfile = os.path.join(batch_folder, f"{header_val}.fasta")
        with open(outfile, 'w', newline='\n') as f:
            f.write(f">{header_val}\n")
            f.write(f"{seq_val}\n")
            f.write(f"{const_header}\n")
            f.write(f"{const_seq}\n")

        count += 1
        print(f"Wrote {outfile}")

    print(f"Total files written: {count}")


# === Main Execution ===
if __name__ == '__main__':
    df = read_excel(INPUT_FILE, SHEET_NAME)
    print("Loaded columns:", df.columns.tolist())
    write_all_fasta(
        df,
        col1=COLUMN1,
        col2=COLUMN2,
        base_outdir=OUTPUT_DIR,
        const_header=CONST_HEADER,
        const_seq=CONST_SEQUENCE,
        sm_prot=SM_PROT,
        files_per_folder=FILES_PER_FOLDER
    )
